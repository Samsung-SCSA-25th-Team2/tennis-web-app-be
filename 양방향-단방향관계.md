# ì—”í‹°í‹° ì–‘ë°©í–¥/ë‹¨ë°©í–¥ ê´€ê³„ ë¦¬íŒ©í† ë§ ê°€ì´ë“œ

í˜„ì¬ ì—”í‹°í‹° êµ¬ì¡°ë¥¼ ì‹¤ë¬´ ê¸°ì¤€ìœ¼ë¡œ ë¶„ì„í•˜ì—¬ **ì–‘ë°©í–¥/ë‹¨ë°©í–¥ ê´€ê³„ë¥¼ ìµœì í™”**í•œ ê°œì„ ì•ˆì„ ì œì‹œí•©ë‹ˆë‹¤.

## í•µì‹¬ ì›ì¹™

**1. ê¸°ë³¸ì€ ë‹¨ë°©í–¥, í•„ìˆ˜ì¸ ê²½ìš°ë§Œ ì–‘ë°©í–¥**  
ì–‘ë°©í–¥ ê´€ê³„ëŠ” ê°ì²´ ë™ê¸°í™” ë³µì¡ë„ë¥¼ ë†’ì´ê³  N+1 ë¬¸ì œë¥¼ ìœ ë°œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.[1][2]

**2. ì»¬ë ‰ì…˜ ì¡°íšŒëŠ” Repository ì¿¼ë¦¬ë¡œ**  
ì—”í‹°í‹°ì— ì»¬ë ‰ì…˜ì„ ë‘ë©´ N+1 ë¬¸ì œê°€ ë°œìƒí•˜ë¯€ë¡œ, í•„ìš” ì‹œ í˜ì´ì§• ì¿¼ë¦¬ë¡œ ì¡°íšŒí•©ë‹ˆë‹¤.[3][4]

**3. ìƒëª…ì£¼ê¸°ê°€ ê¸´ë°€í•œ ê´€ê³„ë§Œ ì–‘ë°©í–¥ ìœ ì§€**  
Cascadeì™€ orphanRemovalì´ í•„ìš”í•œ ë¶€ëª¨-ìì‹ ê´€ê³„ë§Œ ì–‘ë°©í–¥ìœ¼ë¡œ ì„¤ê³„í•©ë‹ˆë‹¤.[5][6]

## ì •ë¦¬

| ì¡°ê±´           | ê¶Œì¥ ì„¤ê³„            | ì´ìœ                 |
|--------------| ---------------- | ----------------- |
| ì—­ë°©í–¥ ì¡°íšŒê±°ì˜ ì—†ìŒ  | ë‹¨ë°©í–¥              | N+1 ë°©ì§€, ë‹¨ìˆœì„± ìœ ì§€    |
| ì—­ë°©í–¥ ì¡°íšŒìì£¼ í•„ìš”  | ì–‘ë°©í–¥              | ê°œë°œ í¸ì˜ì„±, ê°ì²´ ê·¸ë˜í”„ íƒìƒ‰ |
| ì»¬ë ‰ì…˜ì´ ìˆ˜ì²œ ê°œ ì´ìƒ | ë‹¨ë°©í–¥ + Repository | ì„±ëŠ¥ ìš°ì„              |
| ë¶€ëª¨-ìì‹ìƒëª…ì£¼ê¸° ê´€ë¦¬ | ì–‘ë°©í–¥ + cascade    | Cascade ê´€ë¦¬ í•„ìˆ˜     |

> ì „ë¬¸ê°€ ì¡°ì–¸: "ë‹¨ë°©í–¥ìœ¼ë¡œ ì„¤ê³„í•˜ê³ , ì‹¤ì œ ê°œë°œí•˜ë©´ì„œ í•„ìš”í•˜ë©´ ì–‘ë°©í–¥ì„ ì¶”ê°€í•´ë„ ëŠ¦ì§€ ì•ŠìŠµë‹ˆë‹¤. ì–‘ë°©í–¥ì€ í…Œì´ë¸”ì— ì˜í–¥ì„ ì£¼ì§€ ì•Šê¸° ë•Œë¬¸ì…ë‹ˆë‹¤."


## ìƒì„¸ ë¦¬íŒ©í† ë§ ê°€ì´ë“œ

### 1. User â†” MatchGuest: **ì–‘ë°©í–¥ â†’ ë‹¨ë°©í–¥** ğŸ”´

#### í˜„ì¬ êµ¬ì¡° (ë¬¸ì œ)
```java
@Entity
public class User extends BaseTimeEntity {
    @OneToMany(mappedBy = "user")
    private List<MatchGuest> matchGuests = new ArrayList<>();  // âŒ N+1 ìœ„í—˜
}
```

**ë¬¸ì œì **:
- `user.getMatchGuests()` í˜¸ì¶œ ì‹œ N+1 ì¿¼ë¦¬ ë°œìƒ[4][3]
- Userê°€ ìˆ˜ë°± ê°œì˜ ì°¸ê°€ ì´ë ¥ì„ ì»¬ë ‰ì…˜ìœ¼ë¡œ ë³´ìœ  â†’ ë©”ëª¨ë¦¬ ë‚­ë¹„
- ì‹¤ë¬´ì—ì„œëŠ” "íŠ¹ì • ìœ ì €ì˜ ë§¤ì¹˜ ëª©ë¡"ì€ í•­ìƒ í˜ì´ì§• ì²˜ë¦¬ í•„ìš”

#### ê°œì„ ì•ˆ (ë‹¨ë°©í–¥)
```java
@Entity
public class User extends BaseTimeEntity {
    // matchGuests ì»¬ë ‰ì…˜ ì™„ì „ ì œê±° âœ…
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(nullable = false, unique = true)
    private String nickname;
    // ... ë‚˜ë¨¸ì§€ í•„ë“œë§Œ ìœ ì§€
}

// Repositoryì—ì„œ í˜ì´ì§• ì¿¼ë¦¬ë¡œ ì¡°íšŒ
public interface MatchGuestRepository extends JpaRepository<MatchGuest, Long> {
    
    @Query("""
        SELECT mg FROM MatchGuest mg
        JOIN FETCH mg.match m
        JOIN FETCH m.court
        WHERE mg.user.id = :userId
        ORDER BY m.startAt DESC
    """)
    Page<MatchGuest> findByUserIdWithMatch(
        @Param("userId") Long userId, 
        Pageable pageable
    );
}
```

**ê°œì„  íš¨ê³¼**:
- N+1 ë¬¸ì œ ì™„ì „ í•´ê²°
- User ì—”í‹°í‹° ê²½ëŸ‰í™”
- Fetch Joinìœ¼ë¡œ í•„ìš”í•œ ë°ì´í„°ë§Œ íš¨ìœ¨ì  ì¡°íšŒ
- í˜ì´ì§• ì²˜ë¦¬ ìš©ì´

### 2. Match â†” MatchGuest: **ì–‘ë°©í–¥ ìœ ì§€** âœ…

#### í˜„ì¬ êµ¬ì¡° ìœ ì§€ (ì ì ˆ)
```java
@Entity
public class Match extends BaseTimeEntity {
    @OneToMany(mappedBy = "match", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<MatchGuest> matchGuests = new ArrayList<>();
    
    public MatchGuest addGuest(User user) {
        validateGuestCount();
        validateDuplicateGuest(user);
        
        MatchGuest matchGuest = new MatchGuest(this, user);
        this.matchGuests.add(matchGuest);
        return matchGuest;
    }
}
```

**ìœ ì§€ ì´ìœ **:
- Match ì‚­ì œ ì‹œ MatchGuestë„ í•¨ê»˜ ì‚­ì œ í•„ìš” (cascade)[5]
- ë§¤ì¹˜ ìƒì„¸ ì¡°íšŒ ì‹œ í•­ìƒ ì°¸ê°€ì ëª©ë¡ í•„ìš”
- ì°¸ê°€ìì—ì„œ ë§¤ì¹˜ ì •ë³´ ì ‘ê·¼ë„ í•„ìˆ˜

**ìµœì í™” í¬ì¸íŠ¸**:
```java
// Repositoryì—ì„œ Fetch Join ì‚¬ìš©
@Query("""
    SELECT DISTINCT m FROM Match m
    LEFT JOIN FETCH m.matchGuests mg
    LEFT JOIN FETCH mg.user
    WHERE m.id = :matchId
""")
Optional<Match> findByIdWithGuests(@Param("matchId") Long matchId);
```

### 3. Match â†” ChatRoom: **ì–‘ë°©í–¥ â†’ ë‹¨ë°©í–¥** ğŸ”´

#### í˜„ì¬ êµ¬ì¡° (ë¬¸ì œ)
```java
@Entity
public class Match extends BaseTimeEntity {
    @OneToMany(mappedBy = "match", cascade = CascadeType.ALL)
    private Set<ChatRoom> chatRooms = new HashSet<>();  // âŒ ë¶ˆí•„ìš”
}

@Entity
public class ChatRoom extends CreatableEntity {
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "match_id", nullable = false)
    private Match match;  // âŒ ê±°ì˜ ì‚¬ìš© ì•ˆ í•¨
}
```

**ë¬¸ì œì **:
- ë§¤ì¹˜ ì¡°íšŒ ì‹œ ì±„íŒ…ë°©ê¹Œì§€ ë¡œë”© (ë¶ˆí•„ìš”í•œ ê²½ìš° ë§ìŒ)
- ChatRoomì—ì„œ Match ì—”í‹°í‹° ì „ì²´ê°€ í•„ìš”í•œê°€? â†’ **ê±°ì˜ ë¶ˆí•„ìš”**
- ì±„íŒ…ë°© ëª©ë¡ì€ ë³„ë„ APIì—ì„œ ì¡°íšŒ

#### ê°œì„ ì•ˆ (ì™„ì „ ë‹¨ë°©í–¥)
```java
@Entity
public class Match extends BaseTimeEntity {
    // chatRooms ì»¬ë ‰ì…˜ ì œê±° âœ…
}

@Entity
public class ChatRoom extends CreatableEntity {
    // Match ì—”í‹°í‹° ì°¸ì¡° ì œê±°, matchIdë§Œ ë³´ê´€ âœ…
    @Column(name = "match_id")
    private Long matchId;  // ëŠìŠ¨í•œ ê²°í•©
    
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "user1_id", nullable = false)
    private User user1;
    
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "user2_id", nullable = false)
    private User user2;
}

// Repositoryì—ì„œ ì¡°íšŒ
public interface ChatRoomRepository extends JpaRepository<ChatRoom, Long> {
    
    @Query("""
        SELECT cr FROM ChatRoom cr
        WHERE cr.matchId = :matchId
    """)
    List<ChatRoom> findByMatchId(@Param("matchId") Long matchId);
    
    @Query("""
        SELECT cr FROM ChatRoom cr
        WHERE cr.user1.id = :userId OR cr.user2.id = :userId
        ORDER BY cr.createdAt DESC
    """)
    List<ChatRoom> findByUserId(@Param("userId") Long userId);
}
```

**ê°œì„  íš¨ê³¼**:
- Matchì™€ ChatRoomì˜ ê²°í•©ë„ ê°ì†Œ
- Match ì‚­ì œ ì‹œ ChatRoom ì²˜ë¦¬ ì „ëµì„ ìœ ì—°í•˜ê²Œ ì„ íƒ ê°€ëŠ¥
- ì±„íŒ…ë°© ì¡°íšŒ ì„±ëŠ¥ í–¥ìƒ (Match ì—”í‹°í‹° ë¡œë”© ë¶ˆí•„ìš”)

### 4. Match â†” Court: **ë‹¨ë°©í–¥ ìœ ì§€** âœ…

#### í˜„ì¬ êµ¬ì¡° ìœ ì§€ (ì ì ˆ)
```java
@Entity
public class Match extends BaseTimeEntity {
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "court_id", nullable = false)
    private Court court;
}

@Entity
public class Court {
    // Matchë¡œì˜ ì—­ì°¸ì¡° ì—†ìŒ (ì ì ˆ) âœ…
}
```

**ìœ ì§€ ì´ìœ **:
- CourtëŠ” ë§ˆìŠ¤í„° ë°ì´í„°ë¡œ ë…ë¦½ì  ê´€ë¦¬[2]
- "íŠ¹ì • ì½”íŠ¸ì˜ ë§¤ì¹˜ ëª©ë¡"ì€ Repository ì¿¼ë¦¬ë¡œ ì¡°íšŒ

```java
@Query("""
    SELECT m FROM Match m
    WHERE m.court.id = :courtId
    AND m.startAt BETWEEN :start AND :end
    ORDER BY m.startAt
""")
List<Match> findByCourtIdAndDateRange(
    @Param("courtId") Long courtId,
    @Param("start") LocalDateTime start,
    @Param("end") LocalDateTime end
);
```

### 5. ChatRoom â†” User: **ë‹¨ë°©í–¥ ìœ ì§€** âœ…

#### í˜„ì¬ êµ¬ì¡° ìœ ì§€ (ì ì ˆ)
```java
@Entity
public class ChatRoom extends CreatableEntity {
    @ManyToOne(fetch = FetchType.LAZY)
    private User user1;
    
    @ManyToOne(fetch = FetchType.LAZY)
    private User user2;
}

@Entity
public class User extends BaseTimeEntity {
    // ChatRoomìœ¼ë¡œì˜ ì—­ì°¸ì¡° ì—†ìŒ (ì ì ˆ) âœ…
}
```

**ìœ ì§€ ì´ìœ **:
- Userì—ì„œ ì „ì²´ ì±„íŒ…ë°© ëª©ë¡ì€ Repository ì¿¼ë¦¬ë¡œ ì¡°íšŒ[7]
- Userê°€ ìˆ˜ë°± ê°œì˜ ì±„íŒ…ë°©ì„ ì»¬ë ‰ì…˜ìœ¼ë¡œ ë³´ìœ  ì‹œ N+1 ìœ„í—˜[3]

### 6. ChatRoom â†” Chat: **ì–‘ë°©í–¥ ìœ ì§€** âœ…

#### í˜„ì¬ êµ¬ì¡° ìœ ì§€ (ì ì ˆ)
```java
@Entity
public class ChatRoom extends CreatableEntity {
    @OneToMany(mappedBy = "chatRoom", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<Chat> chatList = new ArrayList<>();
}

@Entity
public class Chat extends CreatableEntity {
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "chat_room_id", nullable = false)
    private ChatRoom chatRoom;
}
```

**ìœ ì§€ ì´ìœ **:
- ì±„íŒ…ë°©ê³¼ ë©”ì‹œì§€ëŠ” ìƒëª…ì£¼ê¸°ê°€ ê¸´ë°€ (cascade)[6][5]
- ì±„íŒ…ë°© ì¡°íšŒ ì‹œ ë©”ì‹œì§€ ëª©ë¡ ê±°ì˜ í•­ìƒ í•„ìš”

**ìµœì í™”**:
```java
// í˜ì´ì§•ìœ¼ë¡œ ì¡°íšŒ
@Query("""
    SELECT c FROM Chat c
    JOIN FETCH c.sender
    WHERE c.chatRoom.id = :chatRoomId
    ORDER BY c.createdAt DESC
""")
Page<Chat> findByChatRoomIdWithSender(
    @Param("chatRoomId") Long chatRoomId,
    Pageable pageable
);
```

### 7. Chat â†” User (sender): **ë‹¨ë°©í–¥ ìœ ì§€** âœ…

#### í˜„ì¬ êµ¬ì¡° ìœ ì§€ (ì ì ˆ)
```java
@Entity
public class Chat extends CreatableEntity {
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "sender_id", nullable = false)
    private User sender;
}

@Entity
public class User extends BaseTimeEntity {
    // Chatìœ¼ë¡œì˜ ì—­ì°¸ì¡° ì—†ìŒ (ì ì ˆ) âœ…
}
```

**ìœ ì§€ ì´ìœ **:
- Userì—ì„œ "ë‚´ê°€ ë³´ë‚¸ ëª¨ë“  ì±„íŒ…"ì€ ê±°ì˜ ì¡°íšŒí•˜ì§€ ì•ŠìŒ
- í•„ìš” ì‹œ Repository ì¿¼ë¦¬ë¡œ ì¡°íšŒ

## ìµœì¢… ë¦¬íŒ©í† ë§ ìš”ì•½

| ê´€ê³„ | ë³€ê²½ ì „ | ë³€ê²½ í›„ | ì´ìœ  |
|------|---------|---------|------|
| User â†” MatchGuest | ì–‘ë°©í–¥ | **ë‹¨ë°©í–¥** | N+1 ë°©ì§€, User ê²½ëŸ‰í™” |
| Match â†” MatchGuest | ì–‘ë°©í–¥ | **ì–‘ë°©í–¥ ìœ ì§€** | Cascade ìƒëª…ì£¼ê¸° ê´€ë¦¬ í•„ìˆ˜ |
| Match â†” ChatRoom | ì–‘ë°©í–¥ | **ë‹¨ë°©í–¥** | ëŠìŠ¨í•œ ê²°í•©, ì„±ëŠ¥ í–¥ìƒ |
| Match â†” Court | ë‹¨ë°©í–¥ | **ë‹¨ë°©í–¥ ìœ ì§€** | ë§ˆìŠ¤í„° ë°ì´í„° ë…ë¦½ì„± |
| ChatRoom â†” User | ë‹¨ë°©í–¥ | **ë‹¨ë°©í–¥ ìœ ì§€** | N+1 ë°©ì§€ |
| ChatRoom â†” Chat | ì–‘ë°©í–¥ | **ì–‘ë°©í–¥ ìœ ì§€** | Cascade ìƒëª…ì£¼ê¸° ê´€ë¦¬ í•„ìˆ˜ |
| Chat â†” User | ë‹¨ë°©í–¥ | **ë‹¨ë°©í–¥ ìœ ì§€** | ì¡°íšŒ ë¹ˆë„ ë‚®ìŒ |



## ê°œì„  íš¨ê³¼

### ì„±ëŠ¥ í–¥ìƒ
- **N+1 ì¿¼ë¦¬ ëŒ€í­ ê°ì†Œ**: ì»¬ë ‰ì…˜ ì œê±°ë¡œ ì§€ì—° ë¡œë”© ìµœì†Œí™”[4][3]
- **ì—”í‹°í‹° ê²½ëŸ‰í™”**: User, Matchê°€ ë¶ˆí•„ìš”í•œ ì»¬ë ‰ì…˜ ì œê±°
- **Fetch Join ìµœì í™”**: í•„ìš”í•œ ë°ì´í„°ë§Œ ëª…ì‹œì  ì¡°íšŒ[8]
- **í˜ì´ì§• ì²˜ë¦¬ ìš©ì´**: Repository ì¿¼ë¦¬ë¡œ íš¨ìœ¨ì  í˜ì´ì§•[9]

### ì„¤ê³„ ê°œì„ 
- **ë‹¨ë°©í–¥ ê´€ê³„ 5ê°œ â†’ 7ê°œ**: ì–‘ë°©í–¥ ë³µì¡ë„ ê°ì†Œ[1][2]
- **ì–‘ë°©í–¥ ê´€ê³„ 4ê°œ â†’ 2ê°œ**: í•„ìˆ˜ ê´€ê³„ë§Œ ìœ ì§€[10][7]
- **Cascade ê´€ë¦¬ ë‹¨ìˆœí™”**: ìƒëª…ì£¼ê¸°ê°€ ê¸´ë°€í•œ ê´€ê³„ë§Œ ê´€ë¦¬[5]



## ì‹¤ë¬´ ì ìš© ì‹œ ì£¼ì˜ì‚¬í•­

### 1. ê¸°ì¡´ ì½”ë“œ ì˜í–¥ ë¶„ì„
```java
// Before (ì œê±°ëœ ì½”ë“œ)
List<MatchGuest> guests = user.getMatchGuests();
Set<ChatRoom> rooms = match.getChatRooms();

// After (Repository ì¿¼ë¦¬ë¡œ ë³€ê²½)
Page<MatchGuest> guests = matchGuestRepository.findByUserIdWithMatch(
    user.getId(), 
    PageRequest.of(0, 20)
);
List<ChatRoom> rooms = chatRoomRepository.findByMatchId(match.getId());
```

### 2. Batch Size ì„¤ì •
```properties
# application.yml
spring:
  jpa:
    properties:
      hibernate:
        default_batch_fetch_size: 100
```
â†’ ì»¬ë ‰ì…˜ ì§€ì—° ë¡œë”© ì‹œ IN ì ˆë¡œ ë°°ì¹˜ ì¡°íšŒí•˜ì—¬ N+1 ë¬¸ì œ ì™„í™”[9][3]

### 3. í…ŒìŠ¤íŠ¸ ì½”ë“œ ìˆ˜ì •
- ì—”í‹°í‹° ì§ì ‘ ì ‘ê·¼ ì½”ë“œ â†’ Repository ì¿¼ë¦¬ë¡œ ë³€ê²½
- Cascade ë™ì‘ ê²€ì¦ (Match-MatchGuest, ChatRoom-Chat)

ì´ ë¦¬íŒ©í† ë§ì„ í†µí•´ **ì‹¤ë¬´ ìˆ˜ì¤€ì˜ ì„±ëŠ¥ê³¼ ìœ ì§€ë³´ìˆ˜ì„±**ì„ í™•ë³´í• ë³´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
