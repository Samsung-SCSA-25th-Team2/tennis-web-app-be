# ğŸ” Kakao OAuth 2.0 Login Flow Summary

ì•„ë˜ëŠ” í˜„ì¬ í”„ë¡œì íŠ¸ì˜ ì¹´ì¹´ì˜¤ OAuth2 ì¸ì¦ ì „ì²´ í”Œë¡œìš°ë¥¼ ë‹¨ê³„ë³„ë¡œ ì •ë¦¬í•œ ë¬¸ì„œì…ë‹ˆë‹¤.

---

## ğŸ“ Step 1: í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì‹œì‘

**ê²½ë¡œ:** í”„ë¡ íŠ¸ì—”ë“œ (`https://tennis-web-app-fe.pages.dev`)

```js
const handleKakaoLogin = () => {
  // ë°±ì—”ë“œ OAuth2 ì¸ì¦ ì—”ë“œí¬ì¸íŠ¸ë¡œ ì´ë™
  window.location.href = "https://your-backend.com/api/oauth2/authorization/kakao";
};
```

**íë¦„:**

* ì‚¬ìš©ìê°€ "ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸" í´ë¦­
* ë°±ì—”ë“œ `/api/oauth2/authorization/kakao`ë¡œ ì´ë™

---

## ğŸ“ Step 2: ë°±ì—”ë“œ â ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸

**ê²½ë¡œ:** `SecurityConfig.java:90`

```java
.authorizationEndpoint(authorization -> authorization
  .baseUri("/api/oauth2/authorization")
  .authorizationRequestRepository(cookieOAuth2AuthorizationRequestRepository)
)
```

**íë¦„:**

* Spring Securityê°€ ì¸ì¦ ìš”ì²­ ìƒíƒœë¥¼ ì¿ í‚¤ì— ì €ì¥
* ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ í˜ì´ì§€(`https://kauth.kakao.com/oauth/authorize`)ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸

**ì „ì†¡ë˜ëŠ” íŒŒë¼ë¯¸í„°:**

* client_id
* redirect_uri â†’ `https://your-backend.com/login/oauth2/code/kakao`
* response_type=code

---

## ğŸ“ Step 3: ì‚¬ìš©ìê°€ ì¹´ì¹´ì˜¤ì—ì„œ ë¡œê·¸ì¸ & ë™ì˜

ì‚¬ìš©ìê°€ ì¹´ì¹´ì˜¤ ê³„ì • ë¡œê·¸ì¸ ë° ì •ë³´ ì œê³µ ë™ì˜.

ì¹´ì¹´ì˜¤ê°€ ì¸ì¦ ì½”ë“œë¥¼ í¬í•¨í•˜ì—¬ ì½œë°± URLë¡œ ì´ë™:

```
https://your-backend.com/login/oauth2/code/kakao?code=XXXX
```

---

## ğŸ“ Step 4: ì¹´ì¹´ì˜¤ â†’ ë°±ì—”ë“œ ì½œë°±

**ê²½ë¡œ:** `SecurityConfig.java:92`

```java
.redirectionEndpoint(redirect -> redirect.baseUri("/login/oauth2/code/*"))
```

**Spring Security ìë™ ì²˜ë¦¬:**

1. ì¸ì¦ ì½”ë“œë¡œ ì¹´ì¹´ì˜¤ í† í° ë°œê¸‰ ìš”ì²­
2. Access Token ì´ìš©í•´ ì‚¬ìš©ì ì •ë³´ API í˜¸ì¶œ

---

## ğŸ“ Step 5: CustomOAuth2UserService â€“ ì‚¬ìš©ì ì •ë³´ ì²˜ë¦¬

**ê²½ë¡œ:** `CustomOAuth2UserService.java:30â€“50`

```java
OAuth2User oAuth2User = super.loadUser(userRequest);
OAuth2UserInfo info = new KakaoOAuth2UserInfo(oAuth2User.getAttributes());
User user = saveOrUpdate(info);
return new CustomOAuth2User(info, user.getId());
```

### ğŸ” saveOrUpdate ë¡œì§

* ê¸°ì¡´ ì‚¬ìš©ì â†’ ì¡°íšŒë§Œ ìˆ˜í–‰
* ì‹ ê·œ ì‚¬ìš©ì â†’ DB ì €ì¥
* nickname, gender, period, age ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ null

---

## ğŸ“ Step 6: OAuth2LoginSuccessHandler â€“ JWT ë°œê¸‰

**ê²½ë¡œ:** `OAuth2LoginSuccessHandler.java:44â€“78`

**ì‘ì—…:**

1. Access Token ìƒì„±
2. Refresh Token ìƒì„± ë° Redis ì €ì¥
3. Refresh Token â†’ httpOnly ì¿ í‚¤ë¡œ ì €ì¥
4. Access Token ì¿¼ë¦¬íŒŒë¼ë¯¸í„°ë¡œ í”„ë¡ íŠ¸ì—”ë“œ ì „ë‹¬

```java
String targetUrl = "https://tennis-web-app-fe.pages.dev/auth/callback?accessToken=" + accessToken;
response.sendRedirect(targetUrl);
```

âœ” Refresh Token â†’ ì¿ í‚¤(httpOnly, secure, SameSite=None)
âœ” Access Token â†’ JS ì—ì„œ ì‚¬ìš©í•˜ë„ë¡ URL ì „ë‹¬

---

## ğŸ“ Step 7: í”„ë¡ íŠ¸ì—”ë“œ Callback ì²˜ë¦¬ (/auth/callback)

```js
const accessToken = searchParams.get("accessToken");
localStorage.setItem("accessToken", accessToken);
```

ì´í›„ ì‚¬ìš©ì ìƒíƒœ í™•ì¸ ìš”ì²­:

```js
fetch("https://your-backend.com/api/v1/auth/status", {
  headers: { Authorization: `Bearer ${accessToken}` },
  credentials: "include",
});
```

### ğŸ” ì‚¬ìš©ì í”„ë¡œí•„ ì²´í¬

* nickname, gender, period, age ì¤‘ í•˜ë‚˜ë¼ë„ null â†’ `/complete-profile`
* ëª¨ë‘ ì¡´ì¬ â†’ `/` (ë©”ì¸)

---

## ğŸ“ Step 8: í”„ë¡œí•„ ì™„ì„± íë¦„ (/complete-profile)

```js
fetch("https://your-backend.com/api/v1/users/complete-profile", {
  method: "PATCH",
  headers: {
    Authorization: `Bearer ${accessToken}`,
    "Content-Type": "application/json",
  },
  credentials: "include",
  body: JSON.stringify({ nickname, gender, period, age })
});
```

ì™„ë£Œë˜ë©´ `/` ì´ë™.

---

## ğŸ”„ Access Token ìë™ ê°±ì‹ 

### Axios Request ì¸í„°ì…‰í„°

```js
axios.interceptors.request.use(config => {
  const token = localStorage.getItem("accessToken");
  if (token) config.headers.Authorization = `Bearer ${token}`;
  return config;
});
```

### Axios Response ì¸í„°ì…‰í„° (ë§Œë£Œ ì‹œ ì¬ë°œê¸‰)

```js
if (error.response?.status === 401) {
  const { data } = await axios.post("/api/v1/auth/refresh", {}, { withCredentials: true });
  localStorage.setItem("accessToken", data.accessToken);
  error.config.headers.Authorization = `Bearer ${data.accessToken}`;
  return axios.request(error.config);
}
```

---

## ğŸ“Š ì „ì²´ í”Œë¡œìš° ë‹¤ì´ì–´ê·¸ë¨ (ìš”ì•½)

| ì£¼ì²´      | ë™ì‘                                                    |
| ------- | ----------------------------------------------------- |
| **í”„ë¡ íŠ¸** | ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­ â†’ `/api/oauth2/authorization/kakao` ì´ë™  |
| **ë°±ì—”ë“œ** | ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸                                    |
| **ì¹´ì¹´ì˜¤** | ë¡œê·¸ì¸ & ë™ì˜ í›„ `/login/oauth2/code/kakao` ì½œë°±              |
| **ë°±ì—”ë“œ** | ì½”ë“œ â†’ í† í° ë°œê¸‰ â†’ ìœ ì € ì •ë³´ ì¡°íšŒ                                 |
| **ë°±ì—”ë“œ** | JWT ë°œê¸‰ â†’ RefreshToken ì¿ í‚¤ + AccessToken ì¿¼ë¦¬ ì „ë‹¬          |
| **í”„ë¡ íŠ¸** | `/auth/callback` â†’ AccessToken ì €ì¥ â†’ `/auth/status` í™•ì¸ |
| **í”„ë¡ íŠ¸** | í”„ë¡œí•„ ì—¬ë¶€ì— ë”°ë¼ `/` ë˜ëŠ” `/complete-profile` ì´ë™              |

---

## âœ… ë¬¸ì„œ ì™„ë£Œ

ì¹´ì¹´ì˜¤ OAuth2 ì¸ì¦ í”Œë¡œìš°ë¥¼ ì „ì²´ì ìœ¼ë¡œ ì •ë¦¬í•œ ê³µì‹ ë¬¸ì„œ í˜•íƒœì˜ ë§ˆí¬ë‹¤ìš´ì…ë‹ˆë‹¤.
